<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ANGUS™ - The Strategist</title>
  <!-- STYLES OMITTED FOR BREVITY (leave yours unchanged) -->
</head>
<body>

  <div id="angus-button">ANGUS™ — The Strategist</div>

  <div id="wrap">
    <div id="hdr">ANGUS™ — The Strategist</div>
    <div id="msgs">
      <div class="bubble system-msg">
        Welcome! I'm ANGUS, your strategic health and wellness advisor. How can I help you today?
      </div>
    </div>
    <div id="input-row">
      <input id="inp" placeholder="Ask about health, nutrition, or Herbalife products..." autocomplete="off" />
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    const N8N_URL = "https://homecareers.app.n8n.cloud/webhook/angus-chat";

    let userId = localStorage.getItem('angus_user_id');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('angus_user_id', userId);
    }

    const btn = document.getElementById("angus-button");
    const wrap = document.getElementById("wrap");
    const msgs = document.getElementById("msgs");
    const inp = document.getElementById("inp");
    const sendBtn = document.getElementById("send");

    btn.addEventListener("click", () => {
      const isVisible = wrap.style.display !== "none";
      wrap.style.display = isVisible ? "none" : "block";
      if (!isVisible) {
        inp.focus();
      }
    });

    function addMessage(content, type = "ai", showTimestamp = true) {
      const div = document.createElement("div");
      div.className = `bubble ${type}-msg`;
      let html = content;
      if (showTimestamp) {
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        html += `<div class="timestamp">${time}</div>`;
      }
      div.innerHTML = html;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function showTyping() {
      const div = document.createElement("div");
      div.className = "bubble ai-msg typing-indicator";
      div.innerHTML = '<span class="typing">ANGUS is thinking</span>';
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
      return div;
    }

    function removeTyping(element) {
      if (element && element.parentNode) {
        element.parentNode.removeChild(element);
      }
    }

    async function sendMessage() {
      const text = inp.value.trim();
      if (!text || sendBtn.disabled) return;

      addMessage(`<strong>You:</strong> ${text}`, "user");
      inp.value = "";

      sendBtn.disabled = true;
      sendBtn.textContent = "...";

      const typingElement = showTyping();

      try {
        const response = await fetch(N8N_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "text/plain"
          },
          body: JSON.stringify({ 
            message: text,
            user_id: userId,
            timestamp: new Date().toISOString()
          })
        });

        removeTyping(typingElement);

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const reply = await response.text();

        if (reply) {
          addMessage(`<strong>ANGUS:</strong> ${reply}`, "ai");
        } else {
          throw new Error("Empty response from ANGUS");
        }

      } catch (error) {
        removeTyping(typingElement);
        console.error("Chat error:", error);

        let errorMsg = "I'm having trouble connecting right now. Please try again.";
        if (error.message.includes("Failed to fetch")) {
          errorMsg = "Connection failed. Please check your internet and try again.";
        }

        addMessage(`<strong>Error:</strong> ${errorMsg}`, "error");
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send";
        inp.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    inp.addEventListener("focus", () => {
      setTimeout(() => inp.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
    });

    console.log("ANGUS Chatbot initialized with user ID:", userId);
  </script>
</body>
</html>
