<script>
  // === CONFIG: your n8n PRODUCTION webhook endpoint ===
  const N8N_URL = "https://homecareers.app.n8n.cloud/webhook/angus-chat";

  const $ = sel => document.querySelector(sel);
  const btn = document.getElementById("angus-button") || $("#angus-button");
  const wrap = document.getElementById("wrap") || $("#wrap");
  const msgs = document.getElementById("msgs") || $("#msgs");
  const inp  = document.getElementById("inp")  || $("#inp");
  const sendBtn = document.getElementById("send") || $("#send");

  if (btn && wrap) {
    btn.addEventListener("click", () => {
      wrap.style.display = wrap.style.display === "none" ? "block" : "none";
    });
  }

  function addLine(html, cls = "") {
    const div = document.createElement("div");
    div.className = `bubble ${cls}`.trim();
    div.innerHTML = html;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  }

  // Small helper: fetch with timeout
  function fetchWithTimeout(url, opts = {}, ms = 20000) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), ms);
    return fetch(url, { ...opts, signal: ctrl.signal }).finally(() => clearTimeout(id));
  }

  async function send() {
    const text = (inp.value || "").trim();
    if (!text) return;

    addLine(`<b>You:</b> ${text}`);
    inp.value = "";

    try {
      const res = await fetchWithTimeout(N8N_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      }, 20000);

      const raw = await res.text(); // read raw so we can show it on failure

      if (!res.ok) {
        // Show exact status and server reply
        addLine(`<b>Error:</b> HTTP ${res.status} — ${raw || 'No response body'}`, "err");
        console.error("ANGUS webhook error:", res.status, raw);
        return;
      }

      // Try to parse JSON. If parse fails, show raw.
      let data;
      try { data = JSON.parse(raw); }
      catch (e) {
        addLine(`<b>Error:</b> Invalid JSON from server: ${raw.slice(0, 300)}`, "err");
        console.error("Invalid JSON:", raw);
        return;
      }

      addLine(`<b>Angus:</b> ${data.reply ?? "…"}`);
    } catch (err) {
      // Network errors, timeouts, aborts, etc.
      const msg = (err && err.message) ? err.message : String(err);
      addLine(`<b>Error:</b> ${msg}`, "err");
      console.error("ANGUS network failure:", err);
    }
  }

  if (sendBtn) sendBtn.addEventListener("click", send);
  if (inp) inp.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

  // Optional: open on load
  window.addEventListener("load", () => { if (wrap) wrap.style.display = "block"; });
</script>
